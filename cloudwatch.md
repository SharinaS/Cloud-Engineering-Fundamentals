# CloudWatch

## Index (in the works)

* [Alarms for Instance-Related Events](#Alarms-for-Instance-Related-Events)
* [CloudWatch Agent](#CloudWatch-Agent)
  * [Use CloudWatch Agent](#Use-CloudWatch-Agent)
* [CloudWatch & Auto Scaling Group](#CloudWatch-&-Auto-Scaling-Group)
* [CloudWatch & EC2](#EC2)
* [CloudWatch & Databases](#CloudWatch-&-Databases) 
* [CloudWatch Logs Insights](#CloudWatch-Logs-Insights)
* [CloudWatch Monitoring Scripts](#CloudWatch-Monitoring-Scripts)
* [Demo Console Example](#Do-Things-with-CloudWatch)
* [Metrics Available](#Available-Metrics)

# About CloudWatch

A monitoring service for:

* AWS resources
* Applications run on AWS

> Amazon CloudWatch is a service that monitors AWS cloud resources and the applications you run on AWS. You can use Amazon CloudWatch to collect and track metrics, collect and monitor log files, set alarms, and automatically react to **changes in your AWS resources**. Amazon CloudWatch can monitor AWS resources such as Amazon EC2 instances, Amazon DynamoDB tables, and Amazon RDS DB instances, as well as custom metrics generated by your applications and services, and any log files your applications generate. You can use CloudWatch to detect anomalous behavior in your environments, take automated actions, troubleshoot issues, and discover insights to keep your applications running smoothly. --*AWS Certified Cloud Practitioner Practice Exam Course*

Cloudwatch monitors performance for:

* Compute
  * EC2 Instances
  * Autoscaling groups
  * Elastic load balancers
  * Route53 health checks
* Storage & Content Delivery
  * EBS Volumes
  * Storage Gateways
  * CloudFront

CloudWatch with EC2 will by default monitor events *every 5 minutes* 

* You can have 1 minute intervals by turning on *detailed monitoring*.

## EC2

Using Amazon CloudWatch alarm actions, you can create alarms that automatically **stop, terminate, reboot, or recover** your EC2 instances. You can use the stop or terminate actions to help you save money when you no longer need an instance to be running. You can use the reboot and recover actions to automatically reboot those instances or recover them onto new hardware if a system impairment occurs.

### Available Metrics

CloudWatch can monitor at a **host level**. This includes the default metrics for EC2:

* CPU utilization
* Network utilization
* Disk performance
* Disk Reads/Writes
* Status Check
  * hypervisor
  * EC2 instance

### Custom Metrics

You can look at the existing CloudWatch logs for keywords related to an application error to create a custom metric. Then, create a CloudWatch alarm for that custom metric which invokes an action to restart the EC2 instance.

To monitor custom items you need to prepare a custom metric using a Perl or other shell script, as there are no ready to use metrics for these:

* memory usage
* disk swap utilization
* disk space utilization
* page file utilization
* log collection

### CloudWatch Agent

There is a multi-platform *CloudWatch agent* which can be **installed** on both Linux and Windows-based **instances**. 
 
You can use a single agent to collect both **system metrics and log files** from Amazon EC2 instances and on-premises servers. 

To collect logs from your Amazon EC2 instances and on-premises servers into CloudWatch Logs, AWS offers both a new unified CloudWatch agent, and an older CloudWatch Logs agent. It is recommended to use the unified CloudWatch agent which has the following advantages:

- You can collect both logs and advanced metrics with the installation and configuration of just one agent.

- The unified agent enables the collection of logs from servers running Windows Server.

- If you are using the agent to collect CloudWatch metrics, the unified agent also enables the collection of additional system metrics, for in-guest visibility.

- The unified agent provides better performance.

### Alarms for Instance-Related Events

You can create alarms that automatically stop, terminate, reboot, or recover your EC2 instances using Amazon CloudWatch alarm actions. You can use the stop or terminate actions to help you save money when you no longer need an instance to be running. You can use the reboot and recover actions to automatically reboot those instances or recover them onto new hardware if a system impairment occurs.

### Scenario

There is a new compliance rule in your company that audits every Windows and Linux EC2 instances each month to view any performance issues. They have more than a hundred EC2 instances running in production, and each must have a logging function that collects various system details regarding that instance. The SysOps team will periodically review these logs and analyze their contents using AWS Analytics tools, and the result will need to be retained in an S3 bucket.

In this scenario, what is the most efficient way to collect and analyze logs from the instances with minimal effort?

--> Install the unified CloudWatch Logs agent in each instance which will automatically collect and push data to CloudWatch Logs. Analyze the log data with CloudWatch Logs Insights.

## CloudWatch & Auto Scaling Group

### Scenario

An auto-scaling group of Linux EC2 instances is created with basic monitoring enabled in CloudWatch. You noticed that your application is slow so you asked one of your engineers to check all of your EC2 instances. After checking your instances, you noticed that the auto scaling group is not launching more instances as it should be, even though the servers already have high memory usage.

Which of the following are possible solutions that an Architect can implement to solve this issue? (Select TWO.)

 - Install CloudWatch monitoring scripts in the instances. Send custom metrics to CloudWatch which will trigger your Auto Scaling group to scale up.

- Install the CloudWatch agent to the EC2 instances which will trigger your Auto Scaling group to scale up. [See in this doc about the agent...](#CloudWatch-Agent)

#### CloudWatch Monitoring Scripts

The Amazon CloudWatch Monitoring Scripts for Amazon Elastic Compute Cloud (Amazon EC2) Linux-based instances demonstrate how to produce and consume Amazon CloudWatch custom metrics. These sample Perl scripts comprise a fully functional example that reports memory, swap, and disk space utilization metrics for a Linux instance.

The premise of the above scenario is that the EC2 servers have high memory usage, but since this specific metric is not tracked by the Auto Scaling group by default, the scaling up activity is not being triggered. Remember that by default, CloudWatch doesn't monitor memory usage but only the CPU utilization, Network utilization, Disk performance and Disk Reads/Writes.

This is the reason why you have to install CloudWatch Monitoring Scripts in your EC2 instances to collect and monitor the custom metric (memory usage), which will be used by your Auto Scaling Group as a trigger for scaling activities.

CloudWatch does not monitor EC2 memory usage as well as disk space utilization. You would have to collect the metrics using a script or by using a CloudWatch agent then send the data to CloudWatch.

### Scenario 

A company has an application hosted in an Auto Scaling group of Amazon EC2 instances across multiple Availability Zones behind an Application Load Balancer. There are several occasions where some instances are automatically terminated after failing the HTTPS health checks in the ALB and then purges all the ephemeral logs stored in the instance. A Solutions Architect must implement a solution that collects all of the application and server logs effectively. She should be able to perform a root cause analysis based on the logs, even if the Auto Scaling group immediately terminated the instance.

What is the EASIEST way for the Architect to automate the log collection from the Amazon EC2 instances?

-->  Add a lifecycle hook to your Auto Scaling group to move instances in the Terminating state to the Terminating:Wait state to delay the termination of unhealthy Amazon EC2 instances. Configure a CloudWatch Events rule for the EC2 Instance-terminate Lifecycle Action Auto Scaling Event with an associated Lambda function. Trigger the CloudWatch agent to push the application logs and then resume the instance termination once all the logs are sent to CloudWatch Logs.

#### Use CloudWatch Agent

Using CloudWatch agent is the most suitable tool to use to collect the logs. The unified CloudWatch agent enables you to do the following:

- Collect more system-level metrics from Amazon EC2 instances across operating systems. The metrics can include in-guest metrics, in addition to the metrics for EC2 instances. The additional metrics that can be collected are listed in Metrics Collected by the CloudWatch Agent.

- Collect system-level metrics from on-premises servers. These can include servers in a hybrid environment as well as servers not managed by AWS.

- Retrieve custom metrics from your applications or services using the StatsD and collectd protocols. StatsD is supported on both Linux servers and servers running Windows Server. collectd is supported only on Linux servers.

- Collect logs from Amazon EC2 instances and on-premises servers, running either Linux or Windows Server.

You can store and view the metrics that you collect with the CloudWatch agent in CloudWatch just as you can with any other CloudWatch metrics. The default namespace for metrics collected by the CloudWatch agent is CWAgent, although you can specify a different namespace when you configure the agent.

#### Don't Use Step Functions

Using AWS Step Functions is inappropriate in collecting the logs from your EC2 instances. You should use a CloudWatch agent instead.

## Dashboards

In CloudWatch, you can create dashboards. A dashboard can be created to either show us our region, another region, or even the entire global overview. Essentially, a dashboard shows what is happening in the AWS environment. 

## Alarms

Lets you set alarms to notify you when particular thresholds (ie, billing, cpu usage) are hit.

## Logs

CloudWatch > Logs 

Allows for performance logging. So, you can send all your logs to CloudWatch. Allows for aggregation, monitoring and storing of logs.

### CloudWatch Logs Insights

CloudWatch Logs Insights enables you to interactively search and analyze your log data in Amazon CloudWatch Logs. 

You can perform queries to help you quickly and effectively respond to operational issues. If an issue occurs, you can use CloudWatch Logs Insights to identify potential causes and validate deployed fixes.

CloudWatch Logs Insights includes a purpose-built query language with a few simple but powerful commands. CloudWatch Logs Insights provides sample queries, command descriptions, query autocompletion, and log field discovery to help you get started quickly. Sample queries are included for several types of AWS service logs.

## Events

CloudWatch Events deliver nearly a real-time stream of system events that describe changes in AWS resources. This lets you respond to state changes.

## CloudTrail vs. CloudWatch

Don't get confused! AWS will try to trip you up on an exam about these two services.

CloudTrail records AWS Management Console actions and monitors API calls within the AWS platform.

* Leads to increase in visibility into your user and resource activity.
* Allows for identifying:
  * which users and accounts called AWS
  * source IP address from which the calls were made
  * when the calls were made

So, anytime you make an EC2 instance or an S3 bucket, CloudTrail is making notes. 

* "Who provisioned the EC2 instance?" <-- think CloudTrail

While CloudWatch is about *performance*, CloudTrail is about *auditing*.

* "What's the performance of the EC2 instance?" <-- think CloudWatch

## CloudWatch & Databases

### RDS 

you can use CloudWatch to monitor the CPU Utilization of your database instance, but it does not provide the percentage of the CPU bandwidth and total memory consumed by each database process in your RDS instance.

* Use RDS Enhanced Monitoring instead. See more about metrics in [the databases file](https://github.com/SharinaS/Cloud-Engineering-Fundamentals/blob/master/databases.md)

# Do Things with CloudWatch

### Make the instance with CloudWatch turned on:
Launch a new instance. Amazon Linux 2 AMI, t2.micro. 

In "Configure Instance Details," go down to "Monitoring." Click the radio button that says, "Enable CloudWatch detailed monitoring."
* Checks every minute.

Okay to use default for the "Add Storage" step.

Add some tags

Add to an existing security group - ... use a self-created security group (which has HTTP (source: 0.0.0.0/0), HTTP (::/0) and SSH (0.0.0.0/0) for inbound rules).

Launch. 

### Examine the new instance:
Under the monitoring tab, can see host-level metrics, like the CPU utilization, our disk, network and status checks. We can't see RAM utilization or how much disk storage space is left <-- to do that we need custom metrics, by the way. 

### Test it:
*Goal: Log into the EC2 instance and max out the CPU {evil laugh}.*

Set up an alert that tells us when the CPU utilization goes above a certain percentage:
* Make sure you know what your instance Id is. 
* Go into Management and Governance > CloudWatch
* Click on "Alarms" in the vertical nav bar. 
* Click the blue button, "Create new alarm" 
* Click the button in the middle of the grey square that says "Select metric"
* In the tab "All metrics" down below, click on "EC2," then "Per-Instance Metrics"
* Click the radio button of the InstanceID that is yours, with a "Metric Name" of "CPUUtilization," and click the blue button, "Select metric."
* Midway down the new window, you'll see "Alarm details." Give the alarm a name and a description. Set your CPUUtilization amount you want to be alerted about in "Whenever: CPUUtilization." 
  * The number you choose after giving it a conditional, is a percentage. Ie, >= 90%.
  * The "for 1 out of __ datapoints" means, "for 1 minute out of a minute, for CPUUtilization of greater than 90%, it will send an alarm. 
  * You can edit it to say alternatively other things, like "for 2 minutes out of 5," etc.
* Down scroll down to "Actions," and select who to send the notification to and click "Create Alarm."
  * Click "New list" and add an appropriate email address.

In CloudWatch Alarms, if it says "INSUFFICIENT_DATA," don't be alarmed, it is probably because you are not yet using your instance. 

Go to your EC2 instances, and copy the public IP address of the instance. 

SSH into the instance. After elevating privlages to root, write the following to put the ec2 instance into *an infinite loop* {mwahaha!}:

```
[root@ip-111-11-11-111 ec2-user]# while true; do echo; done
``` 
You'll see a bright blue flashy box... and then you'll get an emailed alarm! In CloudWatch you'll see ALARM is triggered and is bright red.
